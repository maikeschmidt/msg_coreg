%% Example script to create a series of meshes which can be used for simulations and forward modelling

%% Load and process the optical scan - this is the optical scan to which you want to register the simulation meshes to

optical = ft_read_headshape('surface.stl', 'unit', 'mm');
p = struct();
p.vertices = optical.pos;
p.faces = optical.tri;
p2 = reducepatch(p, 0.01); % Reduce complexity of the mesh
subject.pos = p2.vertices;
subject.tri = p2.faces;

% Prepare mesh structure
mesh = struct();
mesh.vertices = subject.pos;
mesh.faces = subject.tri;
mesh.unit = 'mm'; % Define unit explicitly - make sure it matches the grad structure!

%% Load all simulation meshes + Create Sensor array 
% if creating specifically for source reconstruction of collected data make sure the optical scan above is 
% in sensor space or use example script 1 to register in sensor space.
% if you already have sensors set S.sensor_gen to false

S = []; 
S.subject = mesh;
% S.sensors = sensors;
S.sensor_gen = true; %generate sensors (front and back separatly)
S.resolution = 30; % spacing between sensors
S.depth = -10; %sensor offset from mesh surface
S.coverage = [0.25 0.25 0.15 0.15]; %fraction of axis to NOT cover in sensors; top, bottom, left, right (a single number such as 0.6 will cover the top 60% of the mesh)
S.senstype = 'elec'; %default is grad (msg sensors) if senstype is not specified
S.spine_mode = 'full'; %which spine model to load (full or cervical)
S.torso_mode = 'anatomical'; %perfect mri co-reg or manual fid selection (anatomical or canonical)
S.bone_mode = 'realistic'; %type of bone model to load (cont, homo, inhomo, realistic)
S.brain = true;
all_meshes = cr_check_registration(S);


mesh_torso = all_meshes.torso;
mesh_spine = all_meshes.spine;
mesh_bone = all_meshes.bone;
mesh_heart = all_meshes.heart;
mesh_lungs = all_meshes.lungs;
mesh_brain = all_meshes.brain;
mesh_skull = all_meshes.oskull;

sensors_back = all_meshes.back_sensors;
sensors_front = all_meshes.front_sensors;
 
%% create spine sources
y_min = min(mesh_spine.vertices(:,2));
y_max = max(mesh_spine.vertices(:,2));

S = [];
S.spine = mesh_spine;
S.resolution = 5; 
S.ylim = [y_min y_max];
S.unit = 'mm';
spine_sources = cr_generate_spine_center(S);

figure;
hold on;
ft_plot_mesh(mesh_spine, 'facecolor', 'red', 'edgecolor', 'none', 'facealpha', 0.2)
ft_plot_mesh(mesh_bone, 'facecolor', 'none', 'edgecolor', 'blue')
scatter3(spine_sources.pos(:,1),spine_sources.pos(:,2),spine_sources.pos(:,3),'k.')
hold off;

%% Create Brain sources

brain_vertices = mesh_brain.vertices;

x_min = min(brain_vertices(:,1));
x_max = max(brain_vertices(:,1));
y_min = min(brain_vertices(:,2));
y_max = max(brain_vertices(:,2));
z_min = min(brain_vertices(:,3));
z_max = max(brain_vertices(:,3));

resolution = 5;  % change this to whatever you want

[x_grid, y_grid, z_grid] = ndgrid(...
    x_min:resolution:x_max, ...
    y_min:resolution:y_max, ...
    z_min:resolution:z_max);

grid_points = [x_grid(:), y_grid(:), z_grid(:)];

inside_idx = inpolyhedron(mesh_brain.faces, mesh_brain.vertices, grid_points);
brain_sources = grid_points(inside_idx, :);

source_grid = [];
source_grid.pos = brain_sources;      
source_grid.inside = true(size(brain_sources,1),1); 
source_grid.unit = 'mm';

fprintf('Created %d source points inside the brain mesh.\n', size(brain_sources,1));

%% this is everything we need for BEM and FEM forward modelling!

mesh_heart.vertices = mesh_heart.vertices; 
mesh_heart.faces = mesh_heart.faces;

mesh_bone.vertices = mesh_bone.vertices;
mesh_bone.faces = mesh_bone.faces;

mesh_lungs.vertices = mesh_lungs.vertices; 
mesh_lungs.faces = mesh_lungs.faces;

mesh_torso.vertices = mesh_torso.vertices;
mesh_torso.faces = mesh_torso.faces;

mesh_wm.vertices = mesh_spine.vertices;
mesh_wm.faces = mesh_spine.faces;

back_coils_3axis.positions = back_sensors.coilpos;
back_coils_3axis.orientations = back_sensors.coilori;

front_coils_3axis.positions = front_sensors.coilpos;
front_coils_3axis.orientations = front_sensors.coilori;

mesh_brain.vertices = mesh_brain.vertices;
mesh_brain.faces = mesh_brain.faces;
 
mesh_oskull.vertices = mesh_skull.vertices;
mesh_oskull.faces = mesh_skull.faces;

sources_cent = spine_sources;

sources_brain = source_grid.pos;

% coils_3axis = sensors;

transform_matrix = all_meshes.transform;

% Save to .mat
save('geometries_cervical_realistic.mat', 'mesh_wm', 'mesh_bone', 'mesh_heart',...
    'mesh_lungs', 'mesh_torso', 'mesh_brain', 'mesh_oskull','coils_3axis','sources_cent', 'sources_brain', 'transform_matrix');
