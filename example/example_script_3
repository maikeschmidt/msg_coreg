clearvars
close all
clc

cd('D:\');
Metadata;
cr_add_functions;

%% Load and process the optical scan
cd('D:\OPM\scannercast')
optical = stlread('surface.stl');
p = reducepatch(optical, 0.01); % Reduce complexity of the mesh
subject.pos = p.vertices;
subject.tri = p.faces;

% Prepare mesh structure
mesh = struct();
mesh.vertices = subject.pos;
mesh.faces = subject.tri;
mesh.unit = 'mm'; % Define unit explicitly - make sure it matches the grad structure!

% % call in the experimental opm array
sub = 'OP00210';
posfile_back = 'D:\OPM\sub-OP00210\scannercast_positions\positions_all_OP00210.tsv';
savepath = fullfile('D:\OPM\', ['sub-OP', sub(3:end)], 'nervesim');
cd(savepath)

D = {}; 
filetemplate = sprintf('nervesim-right-run_002_array1.lvm');
S = struct(); 
S.data = filetemplate;
S.positions = posfile_back; 
D = spm_opm_create(S); %create spm d structure and extraxt the sensor array

exp_sensors = sensors(D, 'MEG');
%% Load all simulation meshes + Create Sensor array

cd('D:\Simulations\Paper_1\but_actualy\geometries')

S = []; 
S.subject = mesh;
S.sensors = exp_sensors;
% S.sensor_gen = true; %generate sensors (front and back separatly)
% S.resolution = 30; % spacing between sensors
% S.depth = -10; %sensor offset from mesh surface
% S.coverage = [0.25 0 0.15 0.15]; %fraction of axis to NOT cover in sensors; top, bottom, left, right (a single number such as 0.6 will cover the top 60% of the mesh)
% S.fullbody = 0; %full body sensor coverage
% S.senstype = 'elec'; %default is grad (msg sensors) if senstype is not specified
S.spine_mode = 'full'; %which spine model to load (full or cervical)
S.torso_mode = 'anatomical'; %perfect mri co-reg or manual fid selection (anatomical or canonical)
S.bone_mode = 'realistic'; %type of bone model to load (cont, homo, inhomo, realistic)
S.brain = true;
all_meshes = cr_check_registration(S);

brain_transfrom - all_meshes.brains_transform_mat;
